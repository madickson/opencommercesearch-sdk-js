/*! opencommercesearch-sdk-js 2015-07-06 */
var q=require("q"),request=require("superagent");module.exports=function(a){var b=this,c="[ProductApi] ";if("object"!=typeof a)throw c+"must be initialized with a settings object";if(!a.host||!a.site)throw c+"missing required properties for host and/or site";var d={debug:a.debug||!1,host:a.host,isServer:a.isServer||"undefined"==typeof window,preview:a.preview||!1,site:a.site,version:a.version||1},e="/brands",f="/categories",g="/facets",h="/products",i="?q=",j="/queries",k="/rules",l="/suggestions",m="/{{brandId}}",n="/{{categoryId}}",o="/{{id}}",p="/{{productId}}",r="{{query}}",s={apiCall:function(a,b,e){var f,g=!d.isServer,h=q.defer(),i="get"===a.toLowerCase(),j=i?"query":"send";return d.isServer||i?(function k(){var c,f,i;if(d.isServer||!window.XDomainRequest)request(a,b)[j](e).end(function(a,c){return g&&a?(g=!1,b=b.replace(d.host,""),k(this)):void(a?h.reject(a):h.resolve(c.body))});else{i=new XDomainRequest,c=b.indexOf("?")>-1?"&":"?",f="";for(var l in e)f+=l+"+"+encodeURIComponent(e[l]);i.onload=function(){i.responseText&&h.resolve(JSON.parse(i.responseText))||h.resolve},i.onerror=function(a,c,e){return g?(g=!1,b=b.replace(d.host,""),k(this)):void h.reject(e)},i.open("GET",b+c+f),i.send()}}(),h.promise):(f="client only supports GET methods",h.reject("Error: "+f),d.debug&&console.warn(c+f),h.promise)},buildOptions:function(a,b){b="object"==typeof b?b:{},b.site=d.site,b.preview=d.preview;for(var c in a)b[c]=b[c]||a[c];return b},getConfig:function(){return d},processRequest:function(a,b,e){if("object"!=typeof b)throw c+"request for "+a.tpl+" must be an object";var f=s.buildOptions(a.opt,e),g="//"+d.host+"/v"+d.version+this.template(a.tpl,b),h=a.method||"GET";return this.apiCall(h,g,f)},setDebug:function(a){d.debug=a},setHost:function(a){d.host=a},setPreview:function(a){d.preview=a},template:function(a,b){var c,d;for(c in b)d=new RegExp("{{"+c+"}}","g"),a=a.replace(d,b[c]);return a}},t=b.setEndpoint=function(a,d,e){if(!d&&!d.tpl)throw c+"endpoint needs a template";if(!b[a]||e)return b[a]=function(a,b){return s.processRequest(d,a,b)},!0;throw c+"endpoint "+a+" already exists"};t("suggestAll",{tpl:l+i+r}),t("suggestQueries",{opt:{limit:8},tpl:j+l+i+r}),t("findProducts",{tpl:h+p+""}),t("suggestProducts",{opt:{limit:8},tpl:h+l+i+r}),t("searchProducts",{opt:{limit:40},tpl:h+i+r}),t("browseCategory",{tpl:f+n+h}),t("browseBrandCategory",{opt:{limit:40},tpl:e+m+f+n+h}),t("findProductGenerations",{tpl:h+p+"/generations"}),t("findSimilarProducts",{tpl:h+p+"/similar"}),t("findCrossSellProducts",{opt:{limit:8},tpl:h+p+"/recommendations"}),t("suggestCategories",{tpl:f+l+i+r}),t("findCategory",{opt:{limit:8},tpl:f+n}),t("categoryTaxonomy",{opt:{fields:"id,name,childCategories",maxLevels:1,maxChildren:-1,outlet:!1},tpl:f}),t("findCategoryBrands",{tpl:f+n+e}),t("findBrands",{opt:{limit:8},tpl:e+m}),t("findBrandCategories",{opt:{fields:"id,name,childCategories",maxLevels:1,maxChildren:-1,outlet:!1},tpl:e+m+f}),t("suggestBrands",{opt:{limit:8},tpl:e+l+i+r}),t("allBrands",{opt:{limit:2e3},tpl:e}),t("findRules",{tpl:k+o}),t("findFacets",{tpl:g+o}),t("createFacet",{method:"PUT",tpl:g+o}),d.debug?b.helpers=s:delete b.setEndpoint};